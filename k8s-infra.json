{"source":2,"revision":33,"description":null,"createdBy":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"createdOn":"2019-01-21T23:07:59.590Z","modifiedBy":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"modifiedOn":"2019-03-12T21:12:50.050Z","isDeleted":false,"variables":{"ACRName":{"value":"cdk8spu"},"AgentCount":{"value":"2"},"AgentPool":{"value":"k8s-pu-agents"},"AKSName":{"value":"cdk8spu"},"AzDOAccount":{"value":"10m"},"AzDOToken":{"value":null,"isSecret":true},"k8sSpnAppId":{"value":"fbc54165-3b1d-458c-8708-3304825fe659"},"k8sSpnSecret":{"value":null,"isSecret":true},"K8sVersion":{"value":"1.12.6"},"Location":{"value":"WestUS"},"NodeCount":{"value":"2"},"RGName":{"value":"cd-k8s-pu"}},"variableGroups":[],"environments":[{"id":18,"name":"Deploy Infra","rank":1,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":54}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":55},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":56}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":237,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Create Azure Container Registry","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"eb5c3b84-577a-45d8-b97b-668df426557e","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/acr.sh","inlineScript":"","args":"\"$(RGName)\" \"$(Location)\" \"$(ACRName)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Create Azure Kubernetes Service","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"eb5c3b84-577a-45d8-b97b-668df426557e","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/aks.sh","inlineScript":"","args":"\"$(RGName)\" \"$(Location)\" \"$(AKSName)\" $(NodeCount) \"$(k8sSpnAppId)\" \"$(k8sSpnSecret)\" $(K8sVersion)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"kubectl apply","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","kubernetesServiceEndpoint":"","azureSubscriptionEndpoint":"eb5c3b84-577a-45d8-b97b-668df426557e","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","namespace":"","command":"apply","useConfigurationFile":"true","configurationType":"configuration","configuration":"$(System.DefaultWorkingDirectory)/infra/k8s/env/tiller-rbac.yml","inline":"","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.7.0","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"068d5909-43e6-48c5-9e01-7c8a94816220","version":"0.*","name":"Install Helm 2.9.1","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"helmVersion":"2.9.1","checkLatestHelmVersion":"true","installKubeCtl":"true","kubectlVersion":"1.8.9","checkLatestKubeCtl":"true"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm init","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"tiller","command":"init","chartType":"Name","chartName":"","chartPath":"","version":"","releaseName":"","overrideValues":"","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"--service-account tiller","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"Install internal traefik","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"traefik","command":"upgrade","chartType":"Name","chartName":"stable/traefik","chartPath":"","version":"","releaseName":"traefik-internal","overrideValues":"dashboard.enabled=true,dashboard.domain=traefik-internal-ui.aks,serviceType=NodePort,imageTag=1.7.6,kubernetes.IngressClass=traefik-internal,rbac.enabled=true","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":413,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/413","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/6/18"},{"id":19,"name":"Deploy Additional Services","rank":2,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":57}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":58},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":59}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":237,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"068d5909-43e6-48c5-9e01-7c8a94816220","version":"0.*","name":"Install Helm 2.9.1","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"helmVersion":"2.9.1","checkLatestHelmVersion":"true","installKubeCtl":"true","kubectlVersion":"1.8.9","checkLatestKubeCtl":"true"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Deploy Azure DevOps Agents","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"6c613976-9a21-4022-a616-eece13da027b","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/deploy-azdo-agents.sh","inlineScript":"","args":"\"$(AzDOAccount)\" \"$(AzDOToken)\" \"$(AgentPool)\" $(AgentCount) \"$(AKSName)\" \"$(RGName)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/infra/k8s/env","failOnStandardError":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Deploy Prometheus Operator","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"6c613976-9a21-4022-a616-eece13da027b","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/monitoring/create-monitoring.sh","inlineScript":"","args":"\"$(RGName)\" \"$(AKSName)\" monitoring","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/infra/k8s/env/monitoring","failOnStandardError":"false"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade sonarqube","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"sonarqube","command":"upgrade","chartType":"Name","chartName":"stable/sonarqube","chartPath":"","version":"","releaseName":"sonarqube","overrideValues":"service.type=ClusterIP,persistence.enabled=true,persistence.storageClass=default,persistence.size=500Mi,persistence.accessMode=ReadWriteOnce","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"Deploy Infra","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":413,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/413","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/6/19"}],"artifacts":[{"sourceId":"4a32908a-2082-4e50-a403-d7fea7c1ce5e:d2229ebe-a284-48b3-9fbc-168b7bd887a2","type":"Git","alias":"infra","definitionReference":{"branches":{"id":"k8sdevops","name":"k8sdevops"},"checkoutNestedSubmodules":{"id":"True","name":"Any nested submodules within"},"checkoutSubmodules":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionType":{"id":"latestFromBranchType","name":"Latest from the default branch"},"definition":{"id":"d2229ebe-a284-48b3-9fbc-168b7bd887a2","name":"k8s.partsunlimited"},"fetchDepth":{"id":"","name":""},"gitLfsSupport":{"id":"","name":""},"project":{"id":"4a32908a-2082-4e50-a403-d7fea7c1ce5e","name":"Demos"}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"pipelineProcess":{"type":1},"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"Other"}},"id":6,"name":"k8s-infra","path":"\\k8s","projectReference":null,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/definitions/6","_links":{"self":{"href":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/definitions/6"},"web":{"href":"https://dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_release?definitionId=6"}}}