{"source":2,"revision":64,"description":null,"createdBy":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"createdOn":"2019-01-23T19:32:39.127Z","modifiedBy":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"modifiedOn":"2019-03-15T16:01:40.093Z","isDeleted":false,"variables":{"ACRName":{"value":"cdk8spu"},"AKSName":{"value":"cdk8spu"},"BlueTag":{"value":"$(Build.BuildNumber)"},"Environment":{"value":"Production"},"GreenReplicas":{"value":"2"},"GreenTag":{"value":"$(Build.BuildNumber)"},"HelmVersion":{"value":"2.12.3"},"Namespace":{"value":"pu-dev"},"PullSecretName":{"value":"$(ACRName)"},"Repository":{"value":"$(ACRName).azurecr.io/partsunlimited-api"},"RGName":{"value":"cd-k8s-pu"},"ServiceType":{"value":"ClusterIP"},"TraefikClass":{"value":"$(Namespace)-traefik-internal"},"TraefikVersion":{"value":"1.7.8"}},"variableGroups":[],"environments":[{"id":20,"name":"pu-dev","rank":1,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{"Environment":{"value":"Development"},"GreenReplicas":{"value":"1"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":60}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":61},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":62}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":237,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Create an image pull secret","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"eb5c3b84-577a-45d8-b97b-668df426557e","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/image-pull-secret.sh","inlineScript":"","args":"$(RGName) $(ACRName) $(AKSName) $(Namespace)","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"true"}}]},{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":537,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":2,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"068d5909-43e6-48c5-9e01-7c8a94816220","version":"0.*","name":"Install Helm $(HelmVersion)","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"helmVersion":"$(HelmVersion)","checkLatestHelmVersion":"false","installKubeCtl":"true","kubectlVersion":"1.8.9","checkLatestKubeCtl":"true"}},{"environment":{},"taskId":"9240b5c1-a1b2-4799-9325-e071c63236fb","version":"1.*","name":"Replace tokens in $(System.DefaultWorkingDirectory)/infra/k8s","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"sourcePath":"$(System.DefaultWorkingDirectory)/infra/k8s","filePattern":"**/*.release.yaml","tokenRegex":"__(\\w+)__","secretTokens":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade ingress controller","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"Name","chartName":"stable/traefik","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-traefik-internal","overrideValues":"","valueFile":"$(System.DefaultWorkingDirectory)/infra/k8s/env/traefik.internal.values.release.yaml","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade api","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"FilePath","chartName":"","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-api","overrideValues":"","valueFile":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/values.release.yaml","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":1},"schedules":[],"currentRelease":{"id":457,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/457","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/7/20"},{"id":21,"name":"pu-prod-blue","rank":2,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{"Namespace":{"value":"pu-prod"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"id":72}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":64},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":65}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":237,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Create an image pull secret","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"eb5c3b84-577a-45d8-b97b-668df426557e","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/image-pull-secret.sh","inlineScript":"","args":"$(RGName) $(ACRName) $(AKSName) $(Namespace)","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"true"}}]},{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":537,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":2,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"068d5909-43e6-48c5-9e01-7c8a94816220","version":"0.*","name":"Install Helm $(HelmVersion)","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"helmVersion":"$(HelmVersion)","checkLatestHelmVersion":"false","installKubeCtl":"true","kubectlVersion":"1.8.9","checkLatestKubeCtl":"true"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade ingress controller","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"Name","chartName":"stable/traefik","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-traefik-internal","overrideValues":"dashboard.enabled=true,dashboard.domain=traefik-internal-ui.aks,serviceType=NodePort,imageTag=1.7.6,kubernetes.ingressClass=$(Namespace)-traefik-internal,rbac.enabled=true","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Get green tag","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"6c613976-9a21-4022-a616-eece13da027b","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/get-canary-version.sh","inlineScript":"az aks get-credentials -n $(AKSName) -g $(RGName)\ninstalled=$(helm ls | grep $(Namespace)-api | wc -l)\nif [ \"$installed\" = \"1\" ]; then\n  echo \"Get existing green value\"\n  vers=$(kubectl get deploy $(Namespace)-api-partsunlimited-api-green -n $(Namespace) -o jsonpath=\"{.spec.template.spec.containers[?(@.name=='partsunlimited-api')].image}\" | sed 's/.*://')\nelse\n  echo \"No install - use current build number\"\n  version=\"$(Build.BuildNumber)\"\nfi\nif [ \"$vers\" = \"\" ]; then\n  echo \"Unable to determine version - default to build num\"\n  version=\"$(Build.BuildNumber)\"\nfi\necho \"Green version is $vers\"\necho \"##vso[task.setvariable variable=greenVersion]$vers\"","args":"\"$(RGName)\" \"$(AKSName)\" \"$(Namespace)\" \"$(Namespace)-api\" partsunlimited-api green GreenTag \"$(Build.BuildNumber)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"9240b5c1-a1b2-4799-9325-e071c63236fb","version":"1.*","name":"Replace tokens in $(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"sourcePath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","filePattern":"*.release.yaml","tokenRegex":"__(\\w+)__","secretTokens":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade api","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"FilePath","chartName":"","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-api","overrideValues":"","valueFile":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/values.release.yaml","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"pu-dev","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":1},"schedules":[],"currentRelease":{"id":457,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/457","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/7/21"},{"id":22,"name":"pu-prod-green","rank":3,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{"Namespace":{"value":"pu-prod"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"id":73}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":67},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":68}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":537,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Get blue tag","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"6c613976-9a21-4022-a616-eece13da027b","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/get-canary-version.sh","inlineScript":"","args":"\"$(RGName)\" \"$(AKSName)\" \"$(Namespace)\" \"$(Namespace)-api\" partsunlimited-api blue BlueTag \"$(Build.BuildNumber)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"9240b5c1-a1b2-4799-9325-e071c63236fb","version":"1.*","name":"Replace tokens in $(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"sourcePath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/","filePattern":"*.release.yaml","tokenRegex":"__(\\w+)__","secretTokens":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade api","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"FilePath","chartName":"","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-api","overrideValues":"","valueFile":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/values.release.yaml","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"false","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"pu-prod-blue","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":1},"schedules":[],"currentRelease":{"id":457,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/457","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/7/22"},{"id":24,"name":"pu-prod-blue revert","rank":4,"owner":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"variables":{"Namespace":{"value":"pu-prod"}},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Colin Dembovsky","url":"https://spsprodcus2.vssps.visualstudio.com/A931c1e16-94c6-40e3-8294-46e6b397535a/_apis/Identities/b49a1d1e-6a98-6101-a8ad-893410a4943f","_links":{"avatar":{"href":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"}},"id":"b49a1d1e-6a98-6101-a8ad-893410a4943f","uniqueName":"cdembovsky@10thmagnitude.com","imageUrl":"https://dev.azure.com/10m/_apis/GraphProfile/MemberAvatars/aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm","descriptor":"aad.YjQ5YTFkMWUtNmE5OC03MTAxLWE4YWQtODkzNDEwYTQ5NDNm"},"id":74}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":75},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":76}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"api","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]},{"alias":"infra","artifactType":"Git","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":537,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Get green tag","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"6c613976-9a21-4022-a616-eece13da027b","scriptLocation":"scriptPath","scriptPath":"$(System.DefaultWorkingDirectory)/infra/k8s/env/get-canary-version.sh","inlineScript":"","args":"\"$(RGName)\" \"$(AKSName)\" \"$(Namespace)\" \"$(Namespace)-api\" partsunlimited-api green GreenTag \"$(Build.BuildNumber)\"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Set BlueTag to match GreenTag","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"echo \"##vso[task.setvariable variable=BlueTag]$(GreenTag)\"","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"taskId":"9240b5c1-a1b2-4799-9325-e071c63236fb","version":"1.*","name":"Replace tokens in $(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"sourcePath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/","filePattern":"*.release.yaml","tokenRegex":"__(\\w+)__","secretTokens":""}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm upgrade api","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"6c613976-9a21-4022-a616-eece13da027b","azureResourceGroup":"$(RGName)","kubernetesCluster":"$(AKSName)","kubernetesServiceEndpoint":"","namespace":"$(Namespace)","command":"upgrade","chartType":"FilePath","chartName":"","chartPath":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api","version":"","releaseName":"$(Namespace)-api","overrideValues":"","valueFile":"$(System.DefaultWorkingDirectory)/infra/k8s/helm/partsunlimited-api/values.release.yaml","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"false","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":1},"schedules":[],"currentRelease":{"id":311,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/releases/311","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/10m/_apis/public/Release/badge/4a32908a-2082-4e50-a403-d7fea7c1ce5e/7/24"}],"artifacts":[{"sourceId":"4a32908a-2082-4e50-a403-d7fea7c1ce5e:47","type":"Build","alias":"api","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://dev.azure.com/10m/_permalink/_build/index?collectionId=8c04d91a-8fc8-46a4-89ef-ecfce58f53c7&projectId=4a32908a-2082-4e50-a403-d7fea7c1ce5e&definitionId=47","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"47","name":"k8s.PartsUnlimited.API"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"4a32908a-2082-4e50-a403-d7fea7c1ce5e","name":"Demos"},"repository":{"id":"616c2851-45aa-47dc-8d89-11c089a84359","name":"partsunlimited"}},"isPrimary":true,"isRetained":false},{"sourceId":"4a32908a-2082-4e50-a403-d7fea7c1ce5e:d2229ebe-a284-48b3-9fbc-168b7bd887a2","type":"Git","alias":"infra","definitionReference":{"branches":{"id":"k8sdevops","name":"k8sdevops"},"checkoutNestedSubmodules":{"id":"True","name":"Any nested submodules within"},"checkoutSubmodules":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionType":{"id":"latestFromBranchType","name":"Latest from the default branch"},"definition":{"id":"d2229ebe-a284-48b3-9fbc-168b7bd887a2","name":"k8s.partsunlimited"},"fetchDepth":{"id":"","name":""},"gitLfsSupport":{"id":"","name":""},"project":{"id":"4a32908a-2082-4e50-a403-d7fea7c1ce5e","name":"Demos"}},"isRetained":false}],"triggers":[],"releaseNameFormat":"$(Build.BuildNumber)-$(rev:r)","tags":[],"pipelineProcess":{"type":1},"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"Other"}},"id":7,"name":"k8s-pu-api","path":"\\k8s","projectReference":null,"url":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/definitions/7","_links":{"self":{"href":"https://vsrm.dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_apis/Release/definitions/7"},"web":{"href":"https://dev.azure.com/10m/4a32908a-2082-4e50-a403-d7fea7c1ce5e/_release?definitionId=7"}}}